<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Fusion Level03 - Exploit Exercises</title>
<meta name="author" content="Exploit Exercises">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://exploit-exercises.com/fusion/level03">
<link href="/favicon.png" type="image/png" rel="icon">

</span> <span class="o">=</span> <span class="n">json_object_get_string</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">tag_cnt</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
</span><span class='line'>          <span class="n">decode_string</span><span class="p">(</span><span class="n">json_object_get_string</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">title</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">gTitle</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="n">gTitle_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>          <span class="n">memcpy</span><span class="p">(</span><span class="n">gTitle</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;contents&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">contents</span><span class="p">);</span>
</span><span class='line'>          <span class="n">decode_string</span><span class="p">(</span><span class="n">json_object_get_string</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">contents</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">gContents</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="n">gContents_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>          <span class="n">memcpy</span><span class="p">(</span><span class="n">gContents</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;serverip&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">gServerIP</span> <span class="o">=</span> <span class="n">json_object_get_string</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;and done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">post_blog_article</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="s">&quot;80&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">cl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">post</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// We can&#39;t post if there is no information available</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">gServerIP</span> <span class="o">||</span> <span class="o">!</span><span class="n">gContents</span> <span class="o">||</span> <span class="o">!</span><span class="n">gTitle</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">cl</span> <span class="o">=</span> <span class="n">gTitle_len</span> <span class="o">+</span> <span class="n">gContents_len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="s">&quot;POST /blog/post HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Host: %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gServerIP</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Content-Length: %d</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">memcpy</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">gTitle</span><span class="p">,</span> <span class="n">gTitle_len</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">gTitle_len</span><span class="p">;</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">memcpy</span><span class="p">(</span><span class="n">post</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">gContents</span><span class="p">,</span> <span class="n">gContents_len</span><span class="p">);</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">+=</span> <span class="n">gContents_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">gServerIP</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">port</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
</span><span class='line'>  <span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sin</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">gServerIP</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">err</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;socket(): &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="n">err</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;connect(): &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nwrite</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">background_process</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="n">GID</span><span class="p">);</span> 
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">serve_forever</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span><span class='line'>  <span class="n">set_io</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">send_token</span><span class="p">();</span>
</span><span class='line'>  <span class="n">read_request</span><span class="p">();</span>
</span><span class='line'>  <span class="n">validate_request</span><span class="p">();</span>   
</span><span class='line'>  <span class="n">parse_request</span><span class="p">();</span>
</span><span class='line'>  <span class="n">handle_request</span><span class="p">();</span>
</span><span class='line'>  <span class="n">post_blog_article</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>
<footer>
<div class="sharing">
</div>
</footer>
</article>
</div>
<aside class="sidebar col-md-3">
<section>
<h1>Levels</h2>
<div class="list-group">
<a class="list-group-item " href="/fusion/level00/">Level 00</a>
<a class="list-group-item " href="/fusion/level01/">Level 01</a>
<a class="list-group-item " href="/fusion/level02/">Level 02</a>
<a class="list-group-item active" href="/fusion/level03/">Level 03</a>
<a class="list-group-item " href="/fusion/level04/">Level 04</a>
<a class="list-group-item " href="/fusion/level05/">Level 05</a>
<a class="list-group-item " href="/fusion/level06/">Level 06</a>
<a class="list-group-item " href="/fusion/level07/">Level 07</a>
<a class="list-group-item " href="/fusion/level08/">Level 08</a>
<a class="list-group-item " href="/fusion/level09/">Level 09</a>
<a class="list-group-item " href="/fusion/level10/">Level 10</a>
<a class="list-group-item " href="/fusion/level11/">Level 11</a>
<a class="list-group-item " href="/fusion/level12/">Level 12</a>
<a class="list-group-item " href="/fusion/level13/">Level 13</a>
<a class="list-group-item " href="/fusion/level14/">Level 14</a>
</div>
</section>
</aside>
</div>
</div>
</div>
</div>
<footer role="contentinfo"><div class="container">
<p class="text-muted credits">
<div align="center">Copyright &copy; 2014 - Exploit Exercises</div>
</p>
</div>
</footer>
<script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>
</body>
</html>
